# KMS (Key Management Service)

Table of Contents

- [KMS (Key Management Service)](#kms-key-management-service)
- [KMS Key Policies for admins, same-account usage, cross-account usage, key deletion](#kms-key-policies)

---

## KMS (Key Management Service)

- How to rotate imported key?
  - If you choose to import keys to AWS KMS or use a custom key store, you can manually rotate them whenever you want
    by creating a new CMK and mapping a key alias from the old key to the new key.  
- How to rotate CMK Key?
  - You can choose to have AWS KMS automatically rotate CMKs every year, provided that those keys were generated by AWS
    KMS. 
  - Automatic key rotation is not supported for imported keys or keys generated in an AWS CloudHSM cluster using the KMS
    custom key store feature. 
- KMS uses FIPS 140-2 compliant hardware modules to manage access to key material.
- KMS integrates fully with IAM and CloudTrail for permissions management and auditing functions.
- KMS can be optionally used with most AWS services that support encryption.
- CMK (Customer Master Key)
  - CMK is a local representation of a key.
  - Keys can be generated by KMS or imported.
  - CMKs never leave KMS and never leave a region.
  - CMKs can encrypt or decrypt data up to 4 KB in size.
- Key rotation can be automatic 
  - every 3 years for AWS managed CMKs, or
  - every 1 year for customer managed CMKs.
- GenerateDataKey creates a encrypted and plaintext day key. 
  - PlaintextDataKey: The plaintext version is used to encrypt, and then discarded. It’s never stored in plaintext.
  - CipherDataKey: The encrypted version is stored along with the encrypted data; this is envelope encryption.
- KMS is used to decrypt the encrypted key, returning plaintext, and data is decrypted.

### KMS Key Policies

- KMS Key policies are resource policies that control access to the Customer Master Keys (CMKs).
- Unlike most AWS services, the **root** user has **no access to CMKs without specifically being allowed**.
- In cases where nobody has access to CMKs, only AWS can restore access.
- Separating roles/policies for Key Admin and Key Usage
  - A Key Policy can be used to give the account full control of a key, allowing IAM identity policies to control
    access.
  - Removing the policy, nothing can use the key. AWS support is required.
  
    ```
    {
      “Sid”: “xxx”,
      “Effect”: “Allow”,
      “Principal”: {“AWS”: “arn:aws:iam::111122223333:root”},
      “Action”: “kms:*”,
      “Resource”: “*”
    }
    ```
  - Key admins can admin keys, not use them. Permissions granted via IAM policy, or key policy, or both.
    ```
    {
      "Sid": "Allow access for Key Administrators",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::111122223333:user/KMSKeyAdmin"},
      "Action": [
        "kms:Create*",
        "kms:Describe*",
        "kms:Enable*",
        "kms:List*",
        "kms:Put*",
        "kms:Update*",
        "kms:Revoke*",
        "kms:Disable*",
        "kms:Get*",
        "kms:Delete*",
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ],
      "Resource": "*"
    }
    ```
  - KMS has specific operations which are used to utilise the CMKs.  CMKs generally are not used to encrypt data. 
    CMKs generate data keys which perform the encryption and decryption:
    ```
      "Resource": [
        “kms:Encrypt”,
        “kms:Decrypt”,
        “kms:ReEncrypt”,
        “kms:GenerateDataKey*”,
        “kms:DescribeKey”
      ]
    ```
  - Multi-account configuration for using CMK
    - CMKs can be configured to allow other accounts to use them.
    - The Key won’t appear in the external account, but if it is configured using a key policy, that account can
      interact with the key for cryptographic functions.
    - AccountA:
    ```
      "Resource": [
        “arn:...<AccountB_ID>:key/<keyID>”
      ],
    }
    ```
    - AccountB:
      - CloudTrail: putObject to AccountA’s “logs” 
  - For Key admins to be able to delete CMK
    ```
      "Action": [
        ...
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ]
    ```

### KMS Limits
- 1000 customer managed CMKs per region.
- 1100 Aliases per account.
- 2500 Grants per CMK (e.g. max of 2500 EBS volumes using a CMK).
- 5500 Shared API limit
- **Breaching the shared, or per operation limits, result in KMS throttling the requests.**
- Cross-account applies to the SOURCE account.

