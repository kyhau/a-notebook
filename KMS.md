# Encryption and KMS (Key Management Service)

Table of Contents

- [Encryption solution for data at rest and data in transit](#encryption-solution-for-data-at-rest-and-data-in-transit)
- [KMS (Key Management Service)](#kms-key-management-service)
- [KMS Key Policies for admins, same-account usage, cross-account usage, key deletion](#kms-key-policies)


## Encryption solution for data at rest and data in transit

### Data at Rest: KMS

#### DynamoDB
- For any encrypted table created in a region, DynamoDB uses KMS to create an AWS/DynamoDB **service default CMK** (in
  each region).
- When a table is created and set to be encrypted, this CMK is used to create a data key unique to that table, called
  a **table key**. This key is managed by DynamoDB and stored with the table in an encrypted form.
- Every item that DynamoDB encrypts is done with a data encrypted key. That key is encrypted with this table key and
  stored with the data.
- Table keys are cached for up to **12 hours in plaintext** by DynamoDB, but a request is sent to KMS after 5 minutes
  of table key inactivity to check for permission changes.

#### EBS
- EBS Volume is encrypted using a DataKey generated from a CMK.
- Encrypted data key is stored with the volume.
- Used by the **Hypervisor** to decrypt upon attaching to the EC2 instance.
- IO, Snapshots, and Persisted data are encrypted.

#### RDS
- RDS utilizes EBS for its encryption. RDS instances are managed versions of EC2 instances, configured to act as a
  managed DB cluster. 
- In a similar way to EC2, encrypted volumes attached to RDS are handled by the host, with persistent data, snapshots
  and IO encrypted and decrypted using KMS.

#### S3
- The DataKey is generated from a CMK (**service default**, or a **custom CMK**).
- Every object in a bucket is encrypted by S3 using a DataKey provided by KMS.
- CipherText DataKey is stored with the object as metadata.
- When decryption is needed, it is passed to KMS (`kms:Decrypt`), and used by S3 to decrypt the object.
- Use Case:
   - You work on a large scale online media website and provide access to videos which are hosted on S3 via pre-signed
     URLs. The media is stored as objects in an S3 bucket in an encrypted state. Your large user base is generating
     slightly over 10,000 media views per second and your application logs have started to show `ThrottlingException`
     errors. 
   - Potential solution: Lodge a support request to increase KMS limits.

#### CloudTrail
- CloudTrail logs are encrypted in SSE-S3 by default, can be changed to SSE-KMS.

#### Kinesis Data Stream
- Data are already encrypted.  Kinesis Data Streams automatically encrypts data before it is at rest by using an KMS
  CMK you specify. 
- Data is encrypted before it is written to the Kinesis stream storage layer, and decrypted after it is retrieved from
  storage. As a result, your data is encrypted at rest within the Kinesis Data Streams service.

#### Kinesis Data Firehose
- Kinesis Data Firehose allows you to encrypt your data after it is delivered to your S3 bucket. 
- While creating your delivery stream, you can choose to encrypt your data with an KMS key that you own.

#### Athena
- You can encrypt
    - The results of all queries in S3, which Athena stores in a location known as the S3 staging directory. 
    - The data in the AWS Glue Data Catalog. 
- At rest:
    - SSE-S3
    - SSE-KMS 
    - CSE-KMS 
    - NOT SUPPORTED SSE-C (customer-provided keys)


## KMS (Key Management Service)

- How to rotate imported key?
  - If you choose to import keys to AWS KMS or use a custom key store, you can manually rotate them whenever you want
    by creating a new CMK and mapping a key alias from the old key to the new key.  
- How to rotate CMK Key?
  - You can choose to have AWS KMS automatically rotate CMKs every year, provided that those keys were generated by AWS
    KMS. 
  - Automatic key rotation is not supported for imported keys or keys generated in an AWS CloudHSM cluster using the KMS
    custom key store feature. 
- KMS uses FIPS 140-2 compliant hardware modules to manage access to key material.
- KMS integrates fully with IAM and CloudTrail for permissions management and auditing functions.
- KMS can be optionally used with most AWS services that support encryption.
- CMK (Customer Master Key)
  - CMK is a local representation of a key.
  - Keys can be generated by KMS or imported.
  - CMKs never leave KMS and never leave a region.
  - CMKs can encrypt or decrypt data up to 4 KB in size.
- Key rotation can be automatic 
  - every 3 years for AWS managed CMKs, or
  - every 1 year for customer managed CMKs.
- GenerateDataKey creates a encrypted and plaintext day key. 
  - PlaintextDataKey: The plaintext version is used to encrypt, and then discarded. It’s never stored in plaintext.
  - CipherDataKey: The encrypted version is stored along with the encrypted data; this is envelope encryption.
- KMS is used to decrypt the encrypted key, returning plaintext, and data is decrypted.

### KMS Key Policies

- KMS Key policies are resource policies that control access to the Customer Master Keys (CMKs).
- Unlike most AWS services, the **root** user has **no access to CMKs without specifically being allowed**.
- In cases where nobody has access to CMKs, only AWS can restore access.
- Separating roles/policies for Key Admin and Key Usage
  - A Key Policy can be used to give the account full control of a key, allowing IAM identity policies to control
    access.
  - Removing the policy, nothing can use the key. AWS support is required.
  
    ```
    {
      “Sid”: “xxx”,
      “Effect”: “Allow”,
      “Principal”: {“AWS”: “arn:aws:iam::111122223333:root”},
      “Action”: “kms:*”,
      “Resource”: “*”
    }
    ```
  - Key admins can admin keys, not use them. Permissions granted via IAM policy, or key policy, or both.
    ```
    {
      "Sid": "Allow access for Key Administrators",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::111122223333:user/KMSKeyAdmin"},
      "Action": [
        "kms:Create*",
        "kms:Describe*",
        "kms:Enable*",
        "kms:List*",
        "kms:Put*",
        "kms:Update*",
        "kms:Revoke*",
        "kms:Disable*",
        "kms:Get*",
        "kms:Delete*",
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ],
      "Resource": "*"
    }
    ```
  - KMS has specific operations which are used to utilise the CMKs.  CMKs generally are not used to encrypt data. 
    CMKs generate data keys which perform the encryption and decryption:
    ```
      "Resource": [
        “kms:Encrypt”,
        “kms:Decrypt”,
        “kms:ReEncrypt”,
        “kms:GenerateDataKey*”,
        “kms:DescribeKey”
      ]
    ```
  - Multi-account configuration for using CMK
    - CMKs can be configured to allow other accounts to use them.
    - The Key won’t appear in the external account, but if it is configured using a key policy, that account can
      interact with the key for cryptographic functions.
    - AccountA:
    ```
      "Resource": [
        “arn:...<AccountB_ID>:key/<keyID>”
      ],
    }
    ```
    - AccountB:
      - CloudTrail: putObject to AccountA’s “logs” 
  - For Key admins to be able to delete CMK
    ```
      "Action": [
        ...
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ]
    ```

### KMS Limits
- 1000 customer managed CMKs per region.
- 1100 Aliases per account.
- 2500 Grants per CMK (e.g. max of 2500 EBS volumes using a CMK).
- 5500 Shared API limit
- **Breaching the shared, or per operation limits, result in KMS throttling the requests.**
- Cross-account applies to the SOURCE account.

