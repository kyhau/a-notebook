# AWS KMS (Key Management Service)

Table of Contents

- [Customer Master Keys (CMKs) and Data Keys](#customer-master-keys-cmks-and-data-keys)
- [Types of CMK](#types-of-cmk)
- [KMS Key Policies for admins, same-account usage, cross-account usage, key deletion](#kms-key-policies)

---

- [AWS services that integrate with AWS KMS](https://docs.aws.amazon.com/kms/latest/developerguide/service-integration.html
) differ in their support for CMKs].
- KMS can create and manage CMKs (Customer Master Keys). 
- KMS can generate Data Keys but does not manage them.

## Customer Master Keys (CMKs) and Data Keys

**CMK (Customer Master Key)**
- CMKs can encrypt or decrypt data up to **4 KB (4086 bytes)** in size.
- You use CMKs to generate, encrypt, and decrypt the **data keys** that you use outside of AWS KMS to encrypt your
  data. This strategy is known as **envelope encryption**.
- CMKs are created in AWS KMS, and never leave AWS KMS unencrypted, and never leave a region.
- To use or manage your CMK, you access them through AWS KMS.
- Keys can be generated by KMS or imported.

**Data Keys**
- Data keys are encryption keys that you can use to encrypt data, including large amounts of data and other data
  encryption keys.
- AWS KMS does not store, manage, or track your data keys.
- AWS KMS does not perform cryptographic operations (encryption) with data keys. 
- You must use them outside of AWS KMS.
- KMS cannot do encryption using DEKs.

## Types of CMK
```
                        | Can view | Can manage | Used only for your AWS account
1. Customer managed CMK | Yes      | Yes        | Yes 
2. AWS managed CMK      | Yes      | No         | Yes 
3. AWS owned CMK        | No       | No         | No
```

### Customer managed CMKs
- Customer managed CMKs are CMKs in your AWS account that you create, own, and manage. 
- You have full control over these CMKs, including establishing and maintaining their key policies, IAM policies, and
  grants, enabling and disabling them, rotating their cryptographic material, adding tags, creating aliases that refer
  to the CMK, and scheduling the CMKs for deletion.
- You can use your customer managed CMKs in cryptographic operations and audit their use in AWS CloudTrail logs.
- Monthly fee + fees for use in excess of the free tier.
- Counted against the AWS KMS limits for your account.

### AWS managed CMKs
- You can identify **AWS managed CMKs** by their aliases - `aws/service-name` (e.g. `aws/redshift`).
- You can view the AWS managed CMKs in your account, view their key policies, and audit their use in AWS CloudTrail
  logs.
  - To view the key policy for an AWS managed CMK, use the `GetKeyPolicy` operation. 
  - You cannot view the key policy in the AWS Management Console, or change it by any means.
- You cannot manage these CMKs or change their permissions.
- You cannot use AWS managed CMKs in cryptographic operations directly; the service that creates them uses them on
  your behalf.
- No monthly fee, but fees for use in excess of the free tier.
- Do not count against limits on the number of CMKs in each region of your account, but when they are used on behalf
  of a principal in your account, they count against request rate limits.

### AWS owned CMKs
- AWS owned CMKs are not in your AWS account. They are part of a collection of CMKs that AWS owns and manages for use
  in multiple AWS accounts. AWS services can use AWS owned CMKs to protect your data.
- You cannot view, manage, or use AWS owned CMKs, or audit their use. However, you do not need to do any work or change
  any programs to protect the keys that encrypt your data.
- No fee charged.
- Do not count against AWS KMS limits for your account.


## Create a data key
- GenerateDataKey creates a encrypted and plaintext day key. 
  - PlaintextDataKey: The plaintext version is used to encrypt, and then discarded. It’s never stored in plaintext.
  - CipherDataKey: The encrypted version is stored along with the encrypted data; this is envelope encryption.
- KMS is used to decrypt the encrypted key, returning plaintext, and data is decrypted.
- KMS integrates fully with IAM and CloudTrail for permissions management and auditing functions.


## Key Rotation
- Key rotation can be automatic (if enabled)
  - every **3 years** for **AWS managed CMKs**, or
  - every **1 year** for **Customer managed CMKs**
- How to rotate imported key?
  - If you choose to import keys to AWS KMS or use a custom key store, you can manually rotate them whenever you want
    by creating a new CMK and mapping a key alias from the old key to the new key.  
- How to rotate CMK Key?
  - You can choose to have AWS KMS automatically rotate CMKs every year (12 months), provided that those keys were
    generated by AWS KMS. 
  - Automatic key rotation is not supported for imported keys or keys generated in an AWS CloudHSM cluster using the KMS
    custom key store feature. 


## Managing access
- KMS uses FIPS140-2 compliant hardware modules to manage access to key material.
- An IAM user can be configured as a key administrator.
  - This user can perform management tasks on keys.
  - This user cannot perform any cryptographic operations using those keys. Additional permissions are required.


## KMS Key Policies
- KMS Key policies are resource policies that control access to the Customer Master Keys (CMKs).
- Unlike most AWS services, the **root** user has **no access to CMKs without specifically being allowed**.
- In cases where nobody has access to CMKs, only AWS can restore access.
- Separating roles/policies for Key Admin and Key Usage
  - A Key Policy can be used to give the account full control of a key, allowing IAM identity policies to control
    access.
  - Removing the policy, nothing can use the key. AWS support is required.
  
    ```
    {
      “Sid”: “xxx”,
      “Effect”: “Allow”,
      “Principal”: {“AWS”: “arn:aws:iam::111122223333:root”},
      “Action”: “kms:*”,
      “Resource”: “*”
    }
    ```
  - Key admins can admin keys, not use them. Permissions granted via IAM policy, or key policy, or both.
    ```
    {
      "Sid": "Allow access for Key Administrators",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::111122223333:user/KMSKeyAdmin"},
      "Action": [
        "kms:Create*",
        "kms:Describe*",
        "kms:Enable*",
        "kms:List*",
        "kms:Put*",
        "kms:Update*",
        "kms:Revoke*",
        "kms:Disable*",
        "kms:Get*",
        "kms:Delete*",
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ],
      "Resource": "*"
    }
    ```
  - KMS has specific operations which are used to utilise the CMKs.  CMKs generally are not used to encrypt data. 
    CMKs generate data keys which perform the encryption and decryption:
    ```
      "Resource": [
        “kms:Encrypt”,
        “kms:Decrypt”,
        “kms:ReEncrypt”,
        “kms:GenerateDataKey*”,
        “kms:DescribeKey”
      ]
    ```
  - Multi-account configuration for using CMK
    - CMKs can be configured to allow other accounts to use them.
    - The Key won’t appear in the external account, but if it is configured using a key policy, that account can
      interact with the key for cryptographic functions.
    - AccountA:
    ```
      "Resource": [
        “arn:...<AccountB_ID>:key/<keyID>”
      ],
    }
    ```
    - AccountB:
      - CloudTrail: putObject to AccountA’s “logs” 
  - For Key admins to be able to delete CMK
    ```
      "Action": [
        ...
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ]
    ```

### KMS Limits
- 1000 Customer managed CMKs per region.
- 1100 Aliases per account.
- 2500 Grants per CMK (e.g. max of 2500 EBS volumes using a CMK).
- 5500 Shared API limit
- **Breaching the shared, or per operation limits, result in KMS throttling the requests.**
- Cross-account applies to the SOURCE account.

