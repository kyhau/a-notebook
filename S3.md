# S3

Table of Contents
- [Limits](#limits)
- [Security](#security)
- [Encryption](#encryption)
- [Cross-Region Replication (CRR)](#cross-region-replication-crr)
- [Optimal storage](#optimal-storage)
- [Storage classes](#storage-classes)
- [Event notifications](#event-notifications)
- [Monitoring with CloudWatch](#cloudwatch)
- [Use cases](#use-cases)
- [Best practices](#best-practices)
s

## Limits
- Objects can be up to 5TB
- Number of buckets per account: 100  (default)
- Request Rates
    - PUT, LIST, DELETE = 300/s  (default)
    - GET = 800/s  (default)
- No bucket size limit; unlimited number of objects in a bucket
- Versioning - once activated cannot be removed; only suspended.

Consistent view: Allows EMR clusters to check for list and read-after-write consistency for Amazon S3 objects written by or synced with EMRFS.

## Security
1. ACL - other accounts
2. Bucket policy - granular access to an S3 bucket
3. IAM Policy - S3 resource level permissions

## Encryption
- In transit
    1. SSL (secure sockets layer)
    2. CSE (client side encryption)
- At rest / server side encryption
    1. S3 (SSE-S3)
    1. KMS (SSE-KMS)
    1. Customer Keys (SSE-C)

## Cross-Region Replication (CRR)

- CRR is configured on a **bucket level** and provides an asynchronous replication of objects from one source bucket to
  one destination bucket located in different AWS regions.
- No retroactive replication, only replicates objects created after enabling CRR.
- CRR replicates un-encrypted and SSE-S3 encrypted objects by default.
- **SSE-C are not supported.**
- SSE-KMS is supported but needs extra configuration.
- By default, ownership and ACLs are replicated and maintained, but CRR can adjust these.
- The storage class is maintained by default.
- Only Customer actions are replicated. Lifecycle events are not replicated.
- When the bucket owner has no permissions, objects are not replicated.
- Add bucket policy to the destination bucket
  ```
  {
     "Version":"2008-10-17",
     "Id":"",
     "Statement":[
        {
           "Sid":"Stmt123",
           "Effect":"Allow",
           "Principal":{
              "AWS":"arn:aws:iam::source-bucket-owner-AWS-acct-ID:root"
           },
           "Action":[
             "s3:ReplicateObject",
             "s3:ReplicateDelete"
           ],
           "Resource":"arn:aws:s3:::destination/*"
        }
     ]
  }
  ```
- You are configuring S3 CRR between two regions and want to be able to replicate objects using SSE-KMS.
  - Add `<ReplicaKmsKeyID>` to the replication configuration.
  - Ensure the CMK referenced is in the destination bucket region.
  - The CMK referenced by the `<ReplicaKmsKeyID>` item, is the CMK to encrypt objects within the destination bucket -
    since KMS is regional, it needs to be the region that the destination bucket is in.


## Optimal storage
- Data storage is “partitioned” across servers.
- The “partition-key” is the folder (if exists) and/or the name of the object.
- Random prefix (e.g. s3://mybucket/kdd8-monday/1030934.csv)
- Reverse sequence keys (e.g. s3://mybucket/10107102/1030934.csv)

## Storage Classes
1. S3 standard
2. S3 IA
    - Minimum object size: 128 KB
    - Minimum storage duration: 30 days
3. Glacier

Lifecycle policy: S3 Standard -> S3 IA -> Glacier

## Event Notifications
PUTs, POSTs, DELETEs can trigger events.

## CloudWatch
- AllRequests, GetRequests, PutRequests, DeleteRequests
- 4XXErrors, 5XXErrors

## Use cases
- [EMRFS](https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-fs.html)
- Storage and backup
- Application file hosting
- Media hosting
- Software delivery
- Store AMIs and snapshots

## Best Practices
- Data sink between services
- Store pre-transformation records
- Transformed records
- Results
- Randomize naming structure for better throughput
- Compress files (if possible) - GZIP, LZO, Snappy
- Leverage custom data formats like ORC, Parquet, AVRO, JSON
