# Some AWS Security Notes

Table of Contents

- [Encryption solution for data at rest and data in transit](#encryption-solution-for-data-at-rest-and-data-in-transit)
- [KMS (Key Management Service)](#kms-key-management-service)
- [KMS Key Policies for admins, same-account usage, cross-account usage, key deletion](#kms-key-policies)
- [VPC Endpoints (Gateway Endpoints and Interface Endpoints)](#vpc-endpoints-gateway-endpoints-and-interface-endpoints)
- [NAT Gateways vs. NAT Instances](#nat-gateways-vs-nat-instances)
- [Egress-Only: NAT Instance/Gateway for IPv4 vs. Engress-Only Internet Gateway for IPv6](#egress-only-nat-instancegateway-for-ipv4-vs-engress-only-internet-gateway-for-ipv6)

## Encryption solution for data at rest and data in transit

### Data at Rest: KMS

#### DynamoDB
- For any encrypted table created in a region, DynamoDB uses KMS to create an AWS/DynamoDB **service default CMK** (in
  each region).
- When a table is created and set to be encrypted, this CMK is used to create a data key unique to that table, called
  a **table key**. This key is managed by DynamoDB and stored with the table in an encrypted form.
- Every item that DynamoDB encrypts is done with a data encrypted key. That key is encrypted with this table key and
  stored with the data.
- Table keys are cached for up to **12 hours in plaintext** by DynamoDB, but a request is sent to KMS after 5 minutes
  of table key inactivity to check for permission changes.

#### EBS
- EBS Volume is encrypted using a DataKey generated from a CMK.
- Encrypted data key is stored with the volume.
- Used by the **Hypervisor** to decrypt upon attaching to the EC2 instance.
- IO, Snapshots, and Persisted data is encrypted.

#### RDS
- RDS utilizes EBS for its encryption. RDS instances are managed versions of EC2 instances, configured to act as a
  managed DB cluster. 
- In a similar way to EC2, encrypted volumes attached to RDS are handled by the host, with persistent data, snapshots
  and IO encrypted and decrypted using KMS.

#### S3
- The DataKey is generated from a CMK (**service default**, or a **custom CMK**).
- Every object in a bucket is encrypted by S3 using a DataKey provided by KMS.
- CipherText DataKey is stored with the object as metadata.
- When decryption is needed, it is passed to KMS (`kms:Decrypt`), and used by S3 to decrypt the object.

#### CloudTrail
- CloudTrail logs are encrypted in SSE-S3 by default, can be changed to SSE-KMS.

#### Kinesis Data Stream
- Data are already encrypted.  Kinesis Data Streams automatically encrypts data before it is at rest by using an KMS
  CMK you specify. 
- Data is encrypted before it is written to the Kinesis stream storage layer, and decrypted after it is retrieved from
  storage. As a result, your data is encrypted at rest within the Kinesis Data Streams service.

#### Kinesis Data Firehose
- Kinesis Data Firehose allows you to encrypt your data after it is delivered to your S3 bucket. 
- While creating your delivery stream, you can choose to encrypt your data with an KMS key that you own.

#### Athena
- You can encrypt
    - The results of all queries in S3, which Athena stores in a location known as the S3 staging directory. 
    - The data in the AWS Glue Data Catalog. 
- At rest:
    - SSE-S3
    - SSE-KMS 
    - CSE-KMS 
    - NOT SUPPORTED SSE-C (customer-provided keys)


## KMS (Key Management Service)

- KMS uses FIPS 140-2 compliant hardware modules to manage access to key material.
- KMS integrates fully with IAM and CloudTrail for permissions management and auditing functions.
- KMS can be optionally used with most AWS services that support encryption.
- CMK (Customer Master Key)
  - CMK is a local representation of a key.
  - Keys can be generated by KMS or imported.
  - CMKs never leave KMS and never leave a region.
  - CMKs can encrypt or decrypt data up to 4 KB in size.
- Key rotation can be automatic 
  - every 3 years for AWS managed CMKs, or
  - every 1 year for customer managed CMKs.
- GenerateDataKey creates a encrypted and plaintext day key. 
  - PlaintextDataKey: The plaintext version is used to encrypt, and then discarded. It’s never stored in plaintext.
  - CipherDataKey: The encrypted version is stored along with the encrypted data; this is envelope encryption.
- KMS is used to decrypt the encrypted key, returning plaintext, and data is decrypted.

### KMS Key Policies

- KMS Key policies are resource policies that control access to the Customer Master Keys (CMKs).
- Unlike most AWS services, the **root** user has **no access to CMKs without specifically being allowed**.
- In cases where nobody has access to CMKs, only AWS can restore access.
- Separating roles/policies for Key Admin and Key Usage
  - A Key Policy can be used to give the account full control of a key, allowing IAM identity policies to control
    access.
  - Removing the policy, nothing can use the key. AWS support is required.
  
    ```
    {
      “Sid”: “xxx”,
      “Effect”: “Allow”,
      “Principal”: {“AWS”: “arn:aws:iam::111122223333:root”},
      “Action”: “kms:*”,
      “Resource”: “*”
    }
    ```
  - Key admins can admin keys, not use them. Permissions granted via IAM policy, or key policy, or both.
    ```
    {
      "Sid": "Allow access for Key Administrators",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::111122223333:user/KMSKeyAdmin"},
      "Action": [
        "kms:Create*",
        "kms:Describe*",
        "kms:Enable*",
        "kms:List*",
        "kms:Put*",
        "kms:Update*",
        "kms:Revoke*",
        "kms:Disable*",
        "kms:Get*",
        "kms:Delete*",
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ],
      "Resource": "*"
    }
    ```
  - KMS has specific operations which are used to utilise the CMKs.  CMKs generally are not used to encrypt data. 
    CMKs generate data keys which perform the encryption and decryption:
    ```
      "Resource": [
        “kms:Encrypt”,
        “kms:Decrypt”,
        “kms:ReEncrypt”,
        “kms:GenerateDataKey*”,
        “kms:DescribeKey”
      ]
    ```
  - Multi-account configuration for using CMK
    - CMKs can be configured to allow other accounts to use them.
    - The Key won’t appear in the external account, but if it is configured using a key policy, that account can
      interact with the key for cryptographic functions.
    - AccountA:
    ```
      "Resource": [
        “arn:...<AccountB_ID>:key/<keyID>”
      ],
    }
    ```
    - AccountB:
      - CloudTrail: putObject to AccountA’s “logs” 
  - For Key admins to be able to delete CMK
    ```
      "Action": [
        ...
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ]
    ```

### KMS Limits
- 1000 customer managed CMKs per region.
- 1100 Aliases per account.
- 2500 Grants per CMK (e.g. max of 2500 EBS volumes using a CMK).
- 5500 Shared API limit
- **Breaching the shared, or per operation limits, result in KMS throttling the requests.**
- Cross-account applies to the SOURCE account.


## VPC Endpoints (Gateway Endpoints and Interface Endpoints)

VPC Endpoints allow access to public AWS services, or service provided by 3rd parties, without requiring an Internet Gateway to be attached to the VPC, or any NAT instance/gateway.
It means your network communications no longer have to flow over the public internet to reach the public interfaces of AWS services such as S3, API Gateways, etc.

**Gateway Endpoints**

- A gateway endpoint is a gateway that is target for a specified route in your route table, used for traffic destined to a supported AWS services.
- Region specific; need to be in the same region.
- Support AWS Public Services
- The following services are supported:
  - S3
  - DynamoDB
- A **gateway endpoint** requires a route in the route tables for any subnets where the gateway will be used.  
  The destination is a “prefix list” (always prefixed with “pl-”), which is virtual entry which represents a service
  in a region.
- E.g. Route: `Destination=pl-1a2b3c4d, Target=vpce-11bb22cc (VPCE-ID)` 
- Specify Endpoint policies, will be applied to the endpoint to limit the functionality of the endpoint.
   ```
   “Resource”: [“arn:aws:s3:::sharedpics”, “arn:aws:s3:::sharedpics/*”]
   ```
- A **resource policy** can be utilised to limit the resource to one or more VPC endpoints.  
- You cannot use `aws:SourceIp` condition, use `aws:sourceVpce` instead.
   ```
   “Principal”: “*”,
   “Action”: “s3:*”,
   “Effect”: “Deny”,
   “Resource”: [“arn:aws:s3:::sharedpics”, “arn:aws:s3:::sharedpics/*”],
   “Condition”: {
     “StringNotEquals”: { “aws:sourceVpce”: “vpce-1a2b3c4d” }
   }
   ```

** Interface Endpoints (powered by AWS PrivateLink)**

- An interface endpoint is an ENI (Elastic Network Interface) with a private IP address that serves as an entry point for traffic destined to a supported service.
- Inject interface into your VPC.
- Allow attach SGs and reference other SGs. (Gateway Endpoints cannot). 
- Do not support endpoint policies like that of Gateway Endpoints.
- AZ-specific; can create interface for each AZ.
- Support AWS Public Services and Third Party Services.
- The following services are supported:
  - CloudWatch Logs
  - EC2 API
  - Kinesis Data Streams
  - SNS
  - KMS
  - Service Catalog
  - Systems Manager
  - ELB API
  - Endpoint services hosted by other AWS accounts 
- Case 0:   Not using Interface Endpoint
  - Instance R (instance on the right) accesses the SNS service through Internet Gateway.
  - DNS: sns.us-east-1.amazonaws.com
  - IP:  52.*.*.* (public IP)
- Case 1:   Using Interface Endpoint
  - Instance L (instance on the left) accesses SNS service using endpoint specific name through the Interface Endpoint.
  - DNS: vpce-<id>.sns.region.amazonaws.com
  - IP:  10.*.*.* (private IP)
- Case 2:  Using Interface Endpoint with Private DNA Name
  - If we want instance R to use Interface Endpoint but we cannot change the default DNS it is referenced.
  - Enable Private DNA Name (when creating new Interface Endpoint)
    - To use private DNS names, ensure that the attributes Enable DNS hostnames and Enable DNS Support are set to true for your VPC.
  - DNS: sns.us-east-1.amazonaws.com (still)
  - IP: 10.*.*.* (private IP).
- Limitations
  - May not be available in all AZs.
  - Support TCP traffic only. 
  - Support IPv4 traffic only.
  - Interface endpoints can be accessed through Direct Connect connection.
  - Interface endpoints can be accessed through intra-region (same region) VPC peering connection from C5, i3.metal, R5, R5D, Z1D instance types only.
  - Interface endpoints cannot be accessed through an inter-region (different regions) VPC peering connection, or an AWS VPN connection.


## NAT Gateways vs. NAT Instances

**NAT Gateways (Network Address Translation Gateways)**
- NAT Gateways are a new “managed” service to complement NAT Instances (older).
- NAT Gateways provide internet access for AWS services (e.g. EC2, Lambda) within private subnets.
- NAT Gateways are located in a single subnet and utilize Elastic IPs.
- NAT Gateways cannot have security groups associated with them.
- NAT Gateways operate in subnets which can have NACLs, and the source (e.g. EC2) subnets can have NACLs.
- E.g. Route: `Destination=0.0.0.0/0, Target=nat-1111222233334444 (NAT-ID)` 
- No need to to concern ingress traffic, just manage outgoing traffic.
- Cannot ssh to a NAT Gateway.
- Cannot do port forward
- Create a NAT Gateway for more than one AZ.

**NAT Instances (Network Address Translation Instances)**
- NAT Instance is a pre-configured EC2 instance performing the same function as NAT Gateway.
- NAT Instances could be secured with NACL (on the private or NAT subnet) and security groups on the NAT instance and source service (e.g. EC2).


## Egress-Only: NAT Instance/Gateway for IPv4 vs. Engress-Only Internet Gateway for IPv6

1. With **IPv4**, all AWS resources have a private IP. Some can be provided with a public IP and connectivity, using an
   **Internet Gateway (IGW)**.  With **IPv4** a **NAT Instance/Gateway** can be utilized to provide **egress-only
   access**.
   
2. **IPv6** addressing is globally unique and publicly routable.  Supported resources in AWS are all publicly
  addressable, so a **NAT Gateway** isn’t an option.

3. An **Egress-Only Internet Gateway (EIGW)** provides a feature-limited Internet Gateway, specifically for **IPv6**,
   and only allowing outbound connections and return traffic (**stateful**).
   No incoming IPv6 connections can be initiated to VPC resources using Egress-Only Gateway.
   
   - The VPC router via a route table needs to have a IPv6 default route (or a specific one) added.
   - E.g. Route: `Destination= ::/0, Target= eigw-1111222233334444 (EIGW-ID)`
   - Note: IPv6 format: (`::/0`), IPv4 format: (`0.0.0.0/0`)
   - Optionally you can have a route for IPv4 traffic via a NAT and IGW combination.
   - You cannot restrict connections based on DNS, IP or authentication on the Gateway itself.
